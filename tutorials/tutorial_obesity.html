<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Customizing Models &mdash; cuda_hybrid 0.1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Data Visualization Using Seaborn" href="data_visualization.html" />
    <link rel="prev" title="Creating a Parallel Model" href="tutorial_parallel.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> cuda_hybrid
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="tutorial_serial.html">Running a Model Serially</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_parallel.html">Creating a Parallel Model</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Customizing Models</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#creating-a-custom-graph">Creating a custom graph</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#fcm">FCM</a></li>
<li class="toctree-l4"><a class="reference internal" href="#abm">ABM</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#running-the-simulation">Running the simulation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#serial">Serial</a></li>
<li class="toctree-l4"><a class="reference internal" href="#parallel">Parallel</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#data-visualization">Data Visualization</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="data_visualization.html">Data Visualization Using Seaborn</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../docs.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contribution.html">Contribution</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">cuda_hybrid</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Tutorials</a> &raquo;</li>
      <li>Customizing Models</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorials/tutorial_obesity.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="customizing-models">
<h1>Customizing Models<a class="headerlink" href="#customizing-models" title="Permalink to this headline"></a></h1>
<p>For the previous use case, the model is automatically generated by the package, where each concept of the FCM is randomly assigned
a value between 0 and 1. However, in some cases, concepts might have different distributions or have different ways of being
generated. This tutorial will show how to use the package in such cases by first illustrating how to create a customized ABM/FCM graph
and then demonstrating how to use that graph with the package in both serial and parallel.</p>
<p>This model used here is based on the model in the paper <em>Modelling the Joint Effect of Social Determinants and Peers on Obesity Among Canadian Adults</em> <a class="footnote-reference brackets" href="#f1" id="id1">1</a>.
In the paper, a hybrid ABM/FCM model was used to assess
how social network structures and the knowledge shared within them play a role in preventing obesity among Canadian adults.
Four different types of networks and different values for probability of accepting good knowledge (<strong>p</strong>) were used,
to show how knowledge and social networks can affect the average obesity rate.
However, in this tutorial, only the <strong>small world network</strong> and <strong>p</strong> of <strong>0.5</strong> will be utilized.
These values can easily be changed by passing different arguments, which will be discussed in later steps.</p>
<section id="creating-a-custom-graph">
<h2>Creating a custom graph<a class="headerlink" href="#creating-a-custom-graph" title="Permalink to this headline"></a></h2>
<section id="fcm">
<h3>FCM<a class="headerlink" href="#fcm" title="Permalink to this headline"></a></h3>
<p>For the FCM model, an instance of networkx.classes.digraph.DiGraph will need to be created, and each node must have an attribute <code class="docutils literal notranslate"><span class="pre">'val'</span></code>,
so the node values can be accessed as followed: <code class="docutils literal notranslate"><span class="pre">graph.nodes['node_name']['val']</span></code></p>
<p>There 13 concepts with 20 edges in this specific use case. The relationships between the concepts and their weights are given in
in the graph below:</p>
<img alt="../_images/conceptMap.gif" src="../_images/conceptMap.gif" />
<p>These edges are put in to a text file and the initial graph is created using <code class="docutils literal notranslate"><span class="pre">networkx.read_edgelist()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>

<span class="n">FCM</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">read_edgelist</span><span class="p">(</span><span class="s1">&#39;obesity.txt&#39;</span><span class="p">,</span> <span class="n">nodetype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">((</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),),</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">())</span>
</pre></div>
</div>
<p>Each node will then be assigned an attribute <code class="docutils literal notranslate"><span class="pre">'val'</span></code> that has the node value.
Since each concept of the model will be generated in a different way (more details can be found in the paper), the <code class="docutils literal notranslate"><span class="pre">val</span></code>
attribute can be added as below for each node:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">FCM</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;Fatness_Perceived_as_Negative&quot;</span><span class="p">][</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.8</span>
<span class="n">FCM</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;Exercise&quot;</span><span class="p">][</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">wald</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<p>Every agent will have the same FCM graph, so all code above can be put into one function called <code class="docutils literal notranslate"><span class="pre">create_obesity_FCM()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>

<span class="n">AGE_RELATED</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;age_related.txt&#39;</span><span class="p">)</span>
<span class="n">INCOME</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;income.txt&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">create_obesity_FCM</span><span class="p">():</span>
    <span class="n">FCM</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">read_edgelist</span><span class="p">(</span><span class="s1">&#39;obesity.txt&#39;</span><span class="p">,</span> <span class="n">nodetype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">((</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),),</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">())</span>
    <span class="c1"># Fatness_Perceived_as_Negative and Belief_in_Personal_Responsibility will both start at 0.8</span>
    <span class="n">FCM</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;Fatness_Perceived_as_Negative&quot;</span><span class="p">][</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.8</span>
    <span class="n">FCM</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;Belief_in_Personal_Responsibility&quot;</span><span class="p">][</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.8</span>
    <span class="c1"># Exercise has inverse gaussian distribution with mu of 1 and lambda of 0.01</span>
    <span class="n">FCM</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;Exercise&quot;</span><span class="p">][</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">wald</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
    <span class="c1"># Food_Intake is around 0.0027 more than Exercise</span>
    <span class="n">FCM</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;Food_Intake&quot;</span><span class="p">][</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FCM</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;Exercise&quot;</span><span class="p">][</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">30.0</span><span class="o">/</span><span class="mf">11000.0</span>
    <span class="c1"># Knowledge has inverse gaussian distribution with mu of 1 and lambda of 0.01</span>
    <span class="n">FCM</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;Knowledge&quot;</span><span class="p">][</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">wald</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
    <span class="c1"># Income is randomly assigned based on the distribution from income.txt</span>
    <span class="n">FCM</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;Income&quot;</span><span class="p">][</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">INCOME</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">p</span> <span class="o">=</span> <span class="n">INCOME</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>
    <span class="c1"># Age-related concepts. Each age will have a different distribution for Stress, Depression, etc.</span>
    <span class="c1"># These information are stored in age_related.txt</span>
    <span class="n">ageInd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">AGE_RELATED</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">p</span> <span class="o">=</span> <span class="n">AGE_RELATED</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="o">-</span> <span class="mi">18</span><span class="p">)</span>
    <span class="n">FCM</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;Age&quot;</span><span class="p">][</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AGE_RELATED</span><span class="p">[</span><span class="n">ageInd</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">propStressed</span> <span class="o">=</span> <span class="n">AGE_RELATED</span><span class="p">[</span><span class="n">ageInd</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
    <span class="n">FCM</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;Stress&quot;</span><span class="p">][</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">propStressed</span><span class="p">,</span> <span class="n">propStressed</span><span class="p">])</span>
    <span class="n">propDepressed</span> <span class="o">=</span> <span class="n">AGE_RELATED</span><span class="p">[</span><span class="n">ageInd</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
    <span class="n">FCM</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;Depression&quot;</span><span class="p">][</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">propDepressed</span><span class="p">,</span> <span class="n">propDepressed</span><span class="p">])</span>
    <span class="n">FCM</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;Antidepressants&quot;</span><span class="p">][</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">FCM</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;Depression&quot;</span><span class="p">][</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">propAnti</span> <span class="o">=</span> <span class="n">AGE_RELATED</span><span class="p">[</span><span class="n">ageInd</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="n">FCM</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;Antidepressants&quot;</span><span class="p">][</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">propAnti</span><span class="p">,</span> <span class="n">propAnti</span><span class="p">])</span>
    <span class="n">propHealth</span> <span class="o">=</span> <span class="n">AGE_RELATED</span><span class="p">[</span><span class="n">ageInd</span><span class="p">][</span><span class="mi">9</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
    <span class="n">FCM</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;Physical_Health&quot;</span><span class="p">][</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">propHealth</span><span class="p">,</span> <span class="n">propHealth</span><span class="p">])</span>
    <span class="n">probObesity</span> <span class="o">=</span> <span class="n">AGE_RELATED</span><span class="p">[</span><span class="n">ageInd</span><span class="p">][</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
    <span class="c1"># Obesity [0, 0.5, 1] for normal, medium, obese</span>
    <span class="n">FCM</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;Obesity&quot;</span><span class="p">][</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">p</span> <span class="o">=</span> <span class="n">probObesity</span><span class="p">)</span>
    <span class="c1"># Weight_Discrimination is the same as Obesity</span>
    <span class="n">FCM</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;Weight_Discrimination&quot;</span><span class="p">][</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FCM</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;Obesity&quot;</span><span class="p">][</span><span class="s2">&quot;val&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">FCM</span>
</pre></div>
</div>
<p>Here are the complete files that were used above:</p>
<p><a class="reference download internal" download="" href="../_downloads/ae7a65ce65c0ee6c600f04b03f94e5d5/obesity.txt"><code class="xref download docutils literal notranslate"><span class="pre">obesity.txt</span></code></a></p>
<p><a class="reference download internal" download="" href="../_downloads/4e507691144695195d7bec07525b18da/age_related.txt"><code class="xref download docutils literal notranslate"><span class="pre">age_related.txt</span></code></a></p>
<p><a class="reference download internal" download="" href="../_downloads/3ed43f19855afe433c23a14ea39852dc/income.txt"><code class="xref download docutils literal notranslate"><span class="pre">income.txt</span></code></a></p>
<p>The last two files were also combined into one excel file: <a class="reference download internal" download="" href="../_downloads/967bf6bdb85f0614519922b2435fb05f/distributions_of_concepts.xlsx"><code class="xref download docutils literal notranslate"><span class="pre">distributions_of_concepts.xlsx</span></code></a></p>
</section>
<section id="abm">
<h3>ABM<a class="headerlink" href="#abm" title="Permalink to this headline"></a></h3>
<p>After having a function to create an FCM for each agent, an instance of <code class="docutils literal notranslate"><span class="pre">networkx.classes.graph.Graph</span></code> will be used for the ABM.
The type of graph will depend on the model.
Each agent, however, must have an <code class="docutils literal notranslate"><span class="pre">'FCM'</span></code> attribute that stores its FCM graph for the package to function correctly.
The FCM graph can the be accessed by <code class="docutils literal notranslate"><span class="pre">abm_graph.nodes[agent][&quot;FCM&quot;]</span></code>.</p>
<p>As mentioned above, the simulation will be run with a small world network, so  <code class="docutils literal notranslate"><span class="pre">networkx.watts_strogatz_graph()</span></code> function
is used here. Every agent will then get its own FCM graph by using <code class="docutils literal notranslate"><span class="pre">create_obesity_FCM</span></code>. The completed ABM/FCM graph will
be passed as an argument to the constructor of the HybridModel to be used with the package:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Same number of nodes and degree as indicated in the paper</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">watts_strogatz_graph</span><span class="p">(</span><span class="mi">2412</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
<span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
        <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">agent</span><span class="p">][</span><span class="s2">&quot;FCM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">create_obesity_FCM</span><span class="p">()</span>
<span class="n">hm</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">HybridModel</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="running-the-simulation">
<h2>Running the simulation<a class="headerlink" href="#running-the-simulation" title="Permalink to this headline"></a></h2>
<p>Running the simulation with a custom graph using the package is the same as running the simulation with a graph generated by
<a class="reference internal" href="../docs.html#cuda_hybrid.create_graph" title="cuda_hybrid.create_graph"><code class="xref py py-func docutils literal notranslate"><span class="pre">create_graph</span></code></a> or <a class="reference internal" href="../docs.html#cuda_hybrid.generate_model" title="cuda_hybrid.generate_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">generate_model</span></code></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For more details about serial run, please refer to <a class="reference internal" href="tutorial_serial.html#running-a-model-serially"><span class="std std-ref">the serial use case</span></a>.</p>
<p>For more details about parallel run, please refer to <a class="reference internal" href="tutorial_parallel.html#creating-a-parallel-model"><span class="std std-ref">the parallel use case</span></a>.</p>
</div>
<p>In the paper, the simulation will be repeated for 10 times, each time for 20 steps. At every time step, each agent will only
interact with one neighbor at random, and only the knowledge concept of the agents will participate in the interaction. If the value of the knowledge concept
from the influencing agent is greater than that of the influenced agent, the influenced agent will have <code class="docutils literal notranslate"><span class="pre">p</span></code> probability
to accept the knowledge from the influencing agent and, thus, take on the same value,
while if it is smaller, the probability of accepting is <code class="docutils literal notranslate"><span class="pre">1-</span> <span class="pre">p</span></code>. (More details about the interaction
between agents can be found in the paper).</p>
<section id="serial">
<h3>Serial<a class="headerlink" href="#serial" title="Permalink to this headline"></a></h3>
<p>The interaction function is provided below. It takes two arguments, <strong>HybridModel</strong> and the probability <strong>p</strong>, which
will be 0.5 in this case (as mentioned above). However, the value of p can be changed to anything between 0 and 1.
At the end the simulation is run using <code class="xref py py-func docutils literal notranslate"><span class="pre">run_serial</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">cuda_hybrid</span> <span class="k">as</span> <span class="nn">md</span>

<span class="k">def</span> <span class="nf">knowledge_influence</span><span class="p">(</span><span class="n">influenced</span><span class="p">,</span> <span class="n">influencing</span><span class="p">,</span> <span class="n">prob</span><span class="p">):</span>
    <span class="n">choices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">influenced</span><span class="p">,</span> <span class="n">influencing</span><span class="p">])</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">influencing</span> <span class="o">&gt;</span> <span class="n">influenced</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="o">-</span><span class="n">prob</span><span class="p">,</span> <span class="n">prob</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">influencing</span> <span class="o">&lt;</span> <span class="n">influenced</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">prob</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">prob</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">choices</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">obesity_interact</span><span class="p">(</span><span class="n">hm</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">hm</span><span class="o">.</span><span class="n">ABM_adj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="c1"># loop through each agent</span>
    <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hm</span><span class="o">.</span><span class="n">ABM_adj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="c1"># grab the neighbors</span>
        <span class="n">neighbors</span> <span class="o">=</span> <span class="n">hm</span><span class="o">.</span><span class="n">get_neighbors</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbors</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">friend</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">hm</span><span class="o">.</span><span class="n">get_neighbors</span><span class="p">(</span><span class="n">agent</span><span class="p">))</span>
            <span class="c1"># get the numeric index for EconomicDevelopment and AbilityOfInsurgentsToControlThePopulation</span>
            <span class="n">knowledgeIdx</span> <span class="o">=</span> <span class="n">hm</span><span class="o">.</span><span class="n">fcm_labels</span><span class="p">[</span><span class="s2">&quot;Knowledge&quot;</span><span class="p">]</span>
            <span class="c1"># agents now influence each other</span>
            <span class="n">hm</span><span class="o">.</span><span class="n">node_future_val</span><span class="p">[</span><span class="n">agent</span><span class="p">][</span><span class="n">knowledgeIdx</span><span class="p">]</span> <span class="o">=</span> <span class="n">knowledge_influence</span><span class="p">(</span>
                <span class="n">hm</span><span class="o">.</span><span class="n">node_val</span><span class="p">[</span><span class="n">agent</span><span class="p">][</span><span class="n">knowledgeIdx</span><span class="p">],</span> <span class="n">hm</span><span class="o">.</span><span class="n">node_val</span><span class="p">[</span><span class="n">friend</span><span class="p">][</span><span class="n">knowledgeIdx</span><span class="p">],</span> <span class="n">p</span>
            <span class="p">)</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">md</span><span class="o">.</span><span class="n">run_serial</span><span class="p">(</span><span class="n">hm</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Obesity&quot;</span><span class="p">,</span> <span class="s2">&quot;Physical_Health&quot;</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="n">obesity_interact</span><span class="p">,</span> <span class="p">[</span><span class="n">hm</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="mi">20</span><span class="p">)[</span><span class="s1">&#39;Obesity&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>The average value of obesity is <code class="docutils literal notranslate"><span class="pre">0.927949481844901</span></code>.</p>
</section>
<section id="parallel">
<h3>Parallel<a class="headerlink" href="#parallel" title="Permalink to this headline"></a></h3>
<p>The interaction function <code class="docutils literal notranslate"><span class="pre">f</span></code> is provided below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">hm</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">hm</span><span class="o">.</span><span class="n">ABM_adj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="c1"># loop through each agent</span>
    <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hm</span><span class="o">.</span><span class="n">ABM_adj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="c1"># grab the neighbors</span>
        <span class="n">friend</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">hm</span><span class="o">.</span><span class="n">get_neighbors</span><span class="p">(</span><span class="n">agent</span><span class="p">))</span>
        <span class="c1"># get the numeric index for Knowledge</span>
        <span class="n">knowledgeIdx</span> <span class="o">=</span> <span class="n">hm</span><span class="o">.</span><span class="n">fcm_labels</span><span class="p">[</span><span class="s2">&quot;Knowledge&quot;</span><span class="p">]</span>
        <span class="c1"># agents now influence each other</span>
        <span class="n">hm</span><span class="o">.</span><span class="n">node_future_val</span><span class="p">[</span><span class="n">agent</span><span class="p">][</span><span class="n">knowledgeIdx</span><span class="p">]</span> <span class="o">=</span> <span class="n">knowledge_influence</span><span class="p">(</span>
            <span class="n">hm</span><span class="o">.</span><span class="n">node_val</span><span class="p">[</span><span class="n">agent</span><span class="p">][</span><span class="n">knowledgeIdx</span><span class="p">],</span> <span class="n">hm</span><span class="o">.</span><span class="n">node_val</span><span class="p">[</span><span class="n">friend</span><span class="p">][</span><span class="n">knowledgeIdx</span><span class="p">]</span>
        <span class="p">)</span>
</pre></div>
</div>
<p>The above function calls the obesity_interact helper function, which simulates the interacting rules between
the influenced and the influencing agents:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">knowledge_influence</span><span class="p">(</span><span class="n">influenced</span><span class="p">,</span> <span class="n">influencing</span><span class="p">):</span>
    <span class="n">probability</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="k">if</span> <span class="n">influencing</span> <span class="o">&gt;</span> <span class="n">influenced</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">probability</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">influencing</span>
    <span class="k">elif</span> <span class="n">influencing</span> <span class="o">&lt;</span> <span class="n">influenced</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">probability</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">influencing</span>
    <span class="k">return</span> <span class="n">influenced</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Like in the previous parallel use case, every function that is used on the GPU will have to be annotated with <code class="docutils literal notranslate"><span class="pre">&#64;cuda.jit()</span></code>
before the definition of the function. In this case, both <code class="docutils literal notranslate"><span class="pre">knowledge_influence</span></code> and <code class="docutils literal notranslate"><span class="pre">f</span></code> have the annotation</p>
</div>
<p>After that, arguments, including the hybrid model, a list of focus nodes, a list of thresholds for the focus nodes,
the maximum number of iterations, a list of arguments for function f, and, optionally, the number of steps,
will be passed to the cuda_main function to run the simulation. In the paper, the simulation was run for 20 steps, so
the same thing is being done here:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cuda_main</span><span class="p">(</span><span class="n">hm</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Obesity&quot;</span><span class="p">,</span> <span class="s2">&quot;Physical_Health&quot;</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">hm</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<p>The result for this is displayed as followed:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">average Obesity: 0.910130181814703</span>
<span class="go">average Physical_Health: -0.8049388421362708</span>
<span class="go">------ Time: 1293.4581656455994</span>
</pre></div>
</div>
</section>
</section>
<section id="data-visualization">
<h2>Data Visualization<a class="headerlink" href="#data-visualization" title="Permalink to this headline"></a></h2>
<p>The model can be run with different values of p, and the results for the average value for the Obesity concept
after 10 replications with two different networks, small world network and scale-free network, are displayed below:</p>
<img alt="../_images/obesity_serial.svg" src="../_images/obesity_serial.svg" /><div class="admonition note">
<p class="admonition-title">Note</p>
<p>For more details about how to create these graphs, please refer to <a class="reference internal" href="data_visualization.html#creating-graphs"><span class="std std-ref">Creating graphs</span></a>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The details about how to set up with different networks can be found int the paper
<em>Modelling the Joint Effect of Social Determinants and Peers on Obesity Among Canadian Adults</em> <a class="footnote-reference brackets" href="#f1" id="id2">1</a></p>
</div>
<p class="rubric">References</p>
<dl class="footnote brackets">
<dt class="label" id="f1"><span class="brackets">1</span><span class="fn-backref">(<a href="#id1">1</a>,<a href="#id2">2</a>)</span></dt>
<dd><p>Giabbanelli, P. J., Jackson, P. J., &amp; Finegood, D. T. (2014). Modelling the joint effect of social determinants
and peers on obesity among Canadian adults. In Theories and simulations of complex social systems (pp. 145-160). Springer,
Berlin, Heidelberg.</p>
</dd>
</dl>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="tutorial_parallel.html" class="btn btn-neutral float-left" title="Creating a Parallel Model" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="data_visualization.html" class="btn btn-neutral float-right" title="Data Visualization Using Seaborn" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Kareem Ghumrawi, Philippe J. Giabbanelli.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>